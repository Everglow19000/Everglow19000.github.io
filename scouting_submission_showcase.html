 <!DOCTYPE html>

  <head>
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <link rel="stylesheet" href="style.css">
    <link rel="icon" type="image/png" href="/images/favicon.png">
    <style>
        body {
            background-color: #000;
            color: #f0f0f0;
            font-family: 'Segoe UI', Tahoma, Geneva, Verdana, sans-serif;
            margin: 0;
            padding: 0;
            box-sizing: border-box;
            line-height: 1.6;
        }

        /* Header with centered logo */
        .page-header {
            text-align: center;
            padding-top: 40px;   /* space from top of page */
            padding-bottom: 20px; /* space below logo */
        }

        /* Logo image styling */
        .logo {
            display: inline-block; /* ensures it centers properly in text-align:center */
            max-width: 800px;      /* adjust to desired size */
            height: auto;
        }

        /* Module container (your submissions section) */
        .modules-container {
            display: flex;
            justify-content: space-around; /* or space-evenly / center */
            align-items: flex-start;
            flex-wrap: wrap;
            padding: 20px;
            min-height: calc(100vh - 200px); /* optional, ensures it fills space */
        }
    </style>
 </head>

<html>
    <body>
        <script src="./api_keys_encryption.js"></script>
        <script src="./common_stuff.js"></script>
        <script type="module">
            // Import the functions you need from the SDKs you need
            import { initializeApp } from "https://www.gstatic.com/firebasejs/12.0.0/firebase-app.js";
            import { getAnalytics } from "https://www.gstatic.com/firebasejs/12.0.0/firebase-analytics.js";
            import { getDatabase, ref, set, child, get, onChildAdded } from "https://www.gstatic.com/firebasejs/12.0.0/firebase-database.js";
            // TODO: Add SDKs for Firebase products that you want to use
            // https://firebase.google.com/docs/web/setup#available-libraries



            function arraysEqual(arr1, arr2) {
                if (arr1.length !== arr2.length) {
                    return false;
                }
                return arr1.every((value, index) => value == arr2[index]);
            }

            function getParams() {
                var idx = document.URL.indexOf('?');
                var params = new Array();
                if (idx != -1) {
                    var pairs = document.URL.substring(idx + 1, document.URL.length).split('&');
                    for (var i = 0; i < pairs.length; i++) {
                        var nameVal = pairs[i].split('=');
                        params[nameVal[0]] = nameVal[1];
                    }
                }
                return params;
            }

            const params = getParams()



            // Your web app's Firebase configuration
            // For Firebase JS SDK v7.20.0 and later, measurementId is optional
            var firebaseConfig = {
                apiKey: "",

                authDomain: "everglowftcscoutingdatabase.firebaseapp.com",

                projectId: "everglowftcscoutingdatabase",

                storageBucket: "everglowftcscoutingdatabase.firebasestorage.app",

                messagingSenderId: "198175864321",

                appId: "1:198175864321:web:7288ae6a3d5f21ba2e3200",

                measurementId: "G-N22KCE322T",

                databaseURL: "https://everglowftcscoutingdatabase-default-rtdb.europe-west1.firebasedatabase.app"

            };

            // Initialize Firebase
            var app
            var database

            async function validatePasswordAndCreateApiKeys(givenPassword) {
                if (arraysEqual(await SHA_256(givenPassword), passwordHash)) {
                    if (app == null || database == null) {
                        firebaseConfig.apiKey = await decryptApiKey(givenPassword, firebaseEncryptedApiKey)
                        app = initializeApp(firebaseConfig)
                        database = getDatabase(app)
                    }
                    return true
                }
                else {
                    alert("Bad Password!")
                    location.href = "/index.html"
                    return false
                }
            }

            function pushValueToFrontWithoutModifyingLength(array, newValue) {
                for (let i = array.length-1; i >= 1; i--) {
                    array[i] = array[i-1]
                }
                array[0] = newValue
            }

            const latestTemplate = {
                teamName: "none",
                timestamp: "none",
                username: "none",
                value: new Map()
            }

            async function getLatestInputsInYearRange(receivedYearRange, amount) {
                if (!database) {
                    await validatePasswordAndCreateApiKeys(inputtedPassword)
                }

                const yearRangeRef = ref(database, receivedYearRange)

                return await get(yearRangeRef).then((snapshot) => {
                    var allInputs = new Array()


                    if (snapshot.exists()) {
                        var latestTeam = null
                        var latestTimestamp = null

                        const allTeams = snapshot.val()
                        const allTeamsKeys = Object.keys(allTeams)
                        for (const teamIndex in allTeamsKeys) {
                            const team = allTeamsKeys[teamIndex]
                            const allTeamTimestamps = Object.keys(allTeams[team])
                            for (const timestampIndex in allTeamTimestamps) {
                                var timestamp = allTeamTimestamps[timestampIndex]

                                const latest = structuredClone(latestTemplate)
                                latest.teamName = convertDatabaseInputToIntended(team)
                                latest.timestamp = timestamp
                                latest.username = allTeams[team][timestamp]["username"]
                                latest.value = new Map([["autonomous", new Map(Object.entries(allTeams[team][timestamp]["autonomous"]))], ["opMode", new Map(Object.entries(allTeams[team][timestamp]["opMode"]))]])

                                allInputs.push(latest)
                            }
                        }
                    }


                    allInputs.sort((a, b) => {
                        var aDate = new Date(a.timestamp)
                        var bDate = new Date(b.timestamp)

                        return bDate - aDate
                    })

                    var results = new Array(amount)
                    for (let i = 0; i < results.length; i++) {
                        if (i < allInputs.length) {
                            results[i] = allInputs[i]
                        }
                        else {
                            results[i] = structuredClone(latestTemplate)
                        }
                    }
                    return results
                })
            }

            function getPassword() {
                if ("password" in params) {
                    return params["password"]
                }
                else {
                    let inputtedPasswordHere = prompt("Please enter the password: ")
                    if (inputtedPasswordHere != null && inputtedPasswordHere != "") {
                        return inputtedPasswordHere
                    }
                }
            }

            const inputtedPassword = getPassword()

            var latestSubmissions
            var isFirstUpdate = true

            if (await validatePasswordAndCreateApiKeys(inputtedPassword)) {
                latestSubmissions = await getLatestInputsInYearRange(get_year_range(), 3)
                updateLatestSubmissionsDisplay()

                var yearRangeRef = ref(database, get_year_range())
                onChildAdded(yearRangeRef, (snapshot) => {
                    if (isFirstUpdate) {
                        isFirstUpdate = false
                    }
                    else if (snapshot.exists()) {
                        var teamName = snapshot.key
                        var timestamps = Object.keys(snapshot.val())

                        var convertedUnixTimes = new Array(timestamps.length)

                        for (let i = 0; i < timestamps.length; i++) {
                            convertedUnixTimes[i] = new Date(timestamps[i]).getTime()
                        }

                        var timestamp = timestamps[convertedUnixTimes.indexOf(Math.max(...convertedUnixTimes))]

                        var data = snapshot.val()[timestamp]

                        if (new Date(timestamp).getTime() > new Date(latestSubmissions[0].timestamp).getTime()) {
                            var latestSubmission = { ...latestTemplate }
                            latestSubmission.teamName = convertDatabaseInputToIntended(teamName)
                            latestSubmission.timestamp = timestamp
                            latestSubmission.username = data["username"]
                            latestSubmission.value = new Map([["autonomous", new Map(Object.entries(data["autonomous"]))], ["opMode", new Map(Object.entries(data["opMode"]))]])
                            pushValueToFrontWithoutModifyingLength(latestSubmissions, latestSubmission)
                            updateLatestSubmissionsDisplay()
                        }
                    }
                })
            }

            //TODO: delete this
            function deepConvertMapToObject(obj) {
                if (obj instanceof Map) {
                    const result = {};
                    for (const [key, value] of obj.entries()) {
                        result[key] = deepConvertMapToObject(value);
                    }
                    return result;
                } else if (Array.isArray(obj)) {
                    return obj.map(deepConvertMapToObject);
                } else if (typeof obj === 'object' && obj !== null) {
                    const result = {};
                    for (const [key, value] of Object.entries(obj)) {
                        result[key] = deepConvertMapToObject(value);
                    }
                    return result;
                } else {
                    return obj;
                }
            }

            function autonomousDigester(auto) {
                const elementToUseInDigestersStartAuto = "<p>"
                const elementTouseInDigestersEndAuto = "</p>"
                return `
                    ${elementToUseInDigestersStartAuto}Classified Artifacts Scored: ${auto.get("classifiedArtifacts")}${elementTouseInDigestersEndAuto}
                    ${elementToUseInDigestersStartAuto}Overflow Artifacts Scored: ${auto.get("overflowArtifacts")}${elementTouseInDigestersEndAuto}
                    ${elementToUseInDigestersStartAuto}Artifacts Matching Pattern: ${auto.get("artifactsMatchingPattern")}${elementTouseInDigestersEndAuto}
                    ${elementToUseInDigestersStartAuto}Did Leave: ${auto.get("didLeave")}${elementTouseInDigestersEndAuto}
                `
            }

            function opmodeDigester(opmode) {
                const elementToUseInDigestersStartOpMode = "<p>"
                const elementTouseInDigestersEndOpMode = "</p>"
                return `
                    ${elementToUseInDigestersStartOpMode}Classified Artifacts Scored: ${opmode.get("classifiedArtifacts")}${elementTouseInDigestersEndOpMode}
                    ${elementToUseInDigestersStartOpMode}Overflow Artifacts Scored: ${opmode.get("overflowArtifacts")}${elementTouseInDigestersEndOpMode}
                    ${elementToUseInDigestersStartOpMode}Depot Artifacts Scored: ${opmode.get("depotArtifacts")}${elementTouseInDigestersEndOpMode}
                    ${elementToUseInDigestersStartOpMode}Artifacts Matching Pattern: ${opmode.get("artifactsMatchingPattern")}${elementTouseInDigestersEndOpMode}
                    ${elementToUseInDigestersStartOpMode}Base Return Done: ${opmode.get("baseReturn")}${elementTouseInDigestersEndOpMode}
                `
            }

            function calculateTotalScore(auto, opmode) {
                const baseReturnScoreCalculator = (baseReturn) => {
                    if (baseReturn === "None") {
                        return 0
                    }
                    else if (baseReturn === "Partial") {
                        return 5
                    }
                    else if (baseReturn === "Full") {
                        return 10
                    }
                    else if (baseReturn === "Bonus") {
                        return 20
                    }
                    return 0
                }

                const didLeaveScoreCalculator = (didLeave) => {
                    if (didLeave == true) {
                        return 3
                    }
                    return 0
                }
                
                return (3*auto.get("classifiedArtifacts"))+(1*auto.get("overflowArtifacts"))+(2*auto.get("artifactsMatchingPattern"))+(didLeaveScoreCalculator(auto.get("didLeave")))+(3*opmode.get("classifiedArtifacts"))+(1*opmode.get("overflowArtifacts"))+(2*opmode.get("artifactsMatchingPattern"))+(1*opmode.get("depotArtifacts"))+(baseReturnScoreCalculator(opmode.get("baseReturn")))
            }


            //TODO: Change this so it actually does something
            function updateLatestSubmissionsDisplay() {
                var resultString = ""
                latestSubmissions.forEach((element, index) => {
                    resultString += `
                            <div class="module submission-display" id="submission-display-module-index-${index}">
                                <div style="font-size: 28px;" class="module-title">${element.teamName}</div>
                                <div class="total-score-display">Total Score: ${calculateTotalScore(element.value.get("autonomous"), element.value.get("opMode"))}p</div>
                                <h3>Autonomous</h3>
                                ${autonomousDigester(element.value.get("autonomous"))}
                                <h3>Teleop</h3>
                                ${opmodeDigester(element.value.get("opMode"))}
                            </div>
                    `})
                document.getElementById("latestSubmissionsDisplay").innerHTML = resultString
            }
        </script>

        <header class="page-header">
            <img src="images/everglow_logo_name_no_background_white_text.png" class="logo">
        </header>

        <div class="modules-container" id="latestSubmissionsDisplay"></div>
    </body>
</html>