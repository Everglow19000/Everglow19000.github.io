<!DOCTYPE html>

<head>
    <style>
        body {
            background-color: black;
            color: #f0f0f0;
            font-family: 'Segoe UI', Tahoma, Geneva, Verdana, sans-serif;
            margin: 0;
            padding: 20px;
            box-sizing: border-box;
        }

        /* Inputs and dropdowns */
        input[type="text"],
        select {
            padding: 12px;
            font-size: 16px;
            border-radius: 6px;
            border: none;
            outline: none;
            margin: 10px 0;
            background-color: rgba(255, 255, 255, 0.1);
            color: #fff;
            width: 100%;
            max-width: 300px;
            box-sizing: border-box;
        }

        /* Buttons */
        button {
            padding: 12px 20px;
            font-size: 16px;
            background-color: #3e5ce4;
            color: white;
            border: none;
            border-radius: 6px;
            margin: 10px 5px 20px 0;
            cursor: pointer;
            transition: background-color 0.3s ease;
            width: 100%;
            max-width: 300px;
        }

        button:hover {
            background-color: #2b44af;
        }

        /* Titles */
        h1 {
            color: #ffffff;
            border-bottom: 2px solid #444;
            padding-bottom: 5px;
            margin-top: 40px;
            font-size: 1.8em;
        }

        /* Modules layout */
        .modules-container {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(250px, 1fr));
            gap: 20px;
            margin-top: 20px;
        }

        /* Individual module card */
        .module {
            background-color: rgba(20, 20, 100, 0.85);
            border-radius: 10px;
            padding: 16px;
            text-align: center;
            box-shadow: 0 4px 10px rgba(0, 0, 0, 0.3);
            transition: transform 0.2s ease, background-color 0.2s ease;
        }

        .module:hover {
            transform: scale(1.02);
            background-color: rgba(40, 40, 140, 0.9);
        }

        /* Module title */
        .module-title {
            font-size: 18px;
            font-weight: bold;
            margin-bottom: 15px;
            color: #fff;
        }

        /* Counter display */
        .counter-display {
            font-size: 32px;
            margin: 10px 0;
            color: #ffdf6b;
        }

        /* Counter buttons */
        .counter-buttons {
            display: flex;
            justify-content: center;
            gap: 15px;
        }

        .counter-btn {
            font-size: 24px;
            width: 44px;
            height: 44px;
            border-radius: 50%;
            border: none;
            background-color: #5c7cfa;
            color: white;
            cursor: pointer;
            transition: background-color 0.2s ease;
        }

        .counter-btn:hover {
            background-color: #4a6edb;
        }

        /* Radio Module Styling */
        .radio input[type="radio"] {
            margin-right: 8px;
        }

        .radio label {
            font-size: 15px;
            display: block;
            margin-bottom: 6px;
            cursor: pointer;
        }

        .radio input[type="radio"]:checked + label {
            font-weight: bold;
            color: #ffe873;
        }

        /* Dropdown menu */
        #yearRangeSelect {
            background-color: rgba(255, 255, 255, 0.15);
            color: #fff;
            border: none;
            padding: 10px;
            border-radius: 6px;
            width: 100%;
            max-width: 300px;
            margin-bottom: 10px;
        }

        /* Responsive tweaks */
        @media (max-width: 600px) {
            body {
                padding: 15px;
            }

            .modules-container {
                grid-template-columns: 1fr;
            }

            h1 {
                font-size: 1.5em;
            }

            button,
            input[type="text"],
            select {
                font-size: 38px;
                padding: 32px;
                width: 100%;
            }

            .counter-display {
                font-size: 28px;
            }

            .counter-btn {
                font-size: 24px;
                width: 56px;
                height: 56px;
            }

            .radio label {
                font-size: 16px;
            }
        }
    </style>
</head>

<html>

<body>
    <!-- SheetJS library -->
    <script src="https://cdnjs.cloudflare.com/ajax/libs/xlsx/0.18.5/xlsx.full.min.js"></script>
    <script type="module">
        // Import the functions you need from the SDKs you need
        import { initializeApp } from "https://www.gstatic.com/firebasejs/12.0.0/firebase-app.js";
        import { getAnalytics } from "https://www.gstatic.com/firebasejs/12.0.0/firebase-analytics.js";
        import { getDatabase, ref, set, child, get } from "https://www.gstatic.com/firebasejs/12.0.0/firebase-database.js";
        // TODO: Add SDKs for Firebase products that you want to use
        // https://firebase.google.com/docs/web/setup#available-libraries


        function arraysEqual(arr1, arr2) {
            if (arr1.length !== arr2.length) {
                return false;
            }
            return arr1.every((value, index) => value == arr2[index]);
        }

        function getParams() {
            var idx = document.URL.indexOf('?');
            var params = new Array();
            if (idx != -1) {
                var pairs = document.URL.substring(idx + 1, document.URL.length).split('&');
                for (var i = 0; i < pairs.length; i++) {
                    var nameVal = pairs[i].split('=');
                    params[nameVal[0]] = nameVal[1];
                }
            }
            return params;
        }

        const params = getParams()


        function base64ToInt8Array(base64String) {
            base64String += "=".repeat((4 - base64String.length % 4) % 4)
            // 1. Decode the Base64 string into a binary string
            //    atob() treats the input as Base64 and returns a string where each character's
            //    Unicode value corresponds to the byte value of the original binary data.
            const binaryString = atob(base64String);

            // 2. Create a int8Array with the same length as the binary string
            const int8Array = new Int8Array(binaryString.length);

            // 3. Populate the int8Array by iterating through the binary string
            //    and getting the character code (byte value) of each character.
            for (let i = 0; i < binaryString.length; i++) {
                int8Array[i] = binaryString.charCodeAt(i);
            }

            return int8Array;
        }

        const encryptedApiKey = "j7imVG6yXcamt9ZS6hYqQxdGZVXmg5C6zlaiOhAFqeujirnZo1itlbimeVcykIll2zgc1vAKiBQXcGM1Ia9wM4eEYJSdb9qGlRaQYWxNkSf6ds0="
        const passwordHash = [16, -21, -25, -78, -24, -118, -123, 106, 55, 4, 43, 80, -6, -43, 62, -18, -104, -64, 72, -16, -22, -60, -113, 63, 98, -66, -79, -46, 74, -86, 85, -16]

        const ITERATIONS = 100_000;
        const KEY_LENGTH = 256;
        const IV_LENGTH = 12;
        const TAG_LENGTH = 16;

        async function decryptApiKey(password) {
            var combined = base64ToInt8Array(encryptedApiKey)

            var salt, iv, encrypted

            salt = combined.slice(0, 16)
            iv = combined.slice(16, 16 + IV_LENGTH)
            encrypted = combined.slice(16 + IV_LENGTH, combined.length)

            const passwordBuffer = new TextEncoder().encode(password)

            const passwordKey = await crypto.subtle.importKey(
                "raw",
                passwordBuffer,
                "PBKDF2",
                false,
                ["deriveKey"]
            )

            const derivedKey = await crypto.subtle.deriveKey(
                {
                    name: "PBKDF2",
                    salt: salt,
                    iterations: ITERATIONS,
                    hash: "SHA-256"
                },
                passwordKey,
                {
                    name: "AES-GCM",
                    length: 256
                },
                false,
                ["decrypt"]
            )

            const decrypted = await crypto.subtle.decrypt(
                {
                    name: "AES-GCM",
                    iv: iv
                },
                derivedKey,
                encrypted
            )

            return new TextDecoder().decode(decrypted)
        }



        // Your web app's Firebase configuration
        // For Firebase JS SDK v7.20.0 and later, measurementId is optional
        var firebaseConfig = {
            apiKey: "",

            authDomain: "everglowftcscoutingdatabase.firebaseapp.com",

            projectId: "everglowftcscoutingdatabase",

            storageBucket: "everglowftcscoutingdatabase.firebasestorage.app",

            messagingSenderId: "198175864321",

            appId: "1:198175864321:web:7288ae6a3d5f21ba2e3200",

            measurementId: "G-N22KCE322T",

            databaseURL: "https://everglowftcscoutingdatabase-default-rtdb.europe-west1.firebasedatabase.app"

        };

        // Initialize Firebase
        var app
        var database

        const sendButton = document.getElementById("sendButton");
        const downloadButton = document.getElementById("downloadScoutingDataButton");
        const yearRangeSelect = document.getElementById("yearRangeSelect");

        function populate_year_range_select() {
            const myRef = ref(database, "/")

            get(myRef).then(snapshot => {
                const allYears = snapshot.val()
                for (const yearIndex in Object.keys(allYears)) {
                    const currYearRange = Object.keys(allYears)[yearIndex]
                    const option = document.createElement("option")
                    option.value = currYearRange
                    option.textContent = currYearRange
                    yearRangeSelect.appendChild(option)
                }
            })
        }


        function get_year_range() {
            if (new Date().getMonth() >= 8) {
                return new Date().getFullYear().toString() + "-" + (new Date().getFullYear() + 1).toString();
            }
            return (new Date().getFullYear() - 1).toString() + "-" + new Date().getFullYear().toString();
        }

        function write_to_firebase() {
            var currISOString = new Date().toISOString()
            currISOString = currISOString.substring(0, currISOString.indexOf(".")).replace("T", " ")
            const myRef = ref(database, get_year_range() + '/' + document.getElementById("teamNameInput").value + '/' + currISOString);

            console.log(counters)


            set(myRef, {
                "autonomous": {
                    "netSamples": counters.get("autonomous").get("Net Samples"),
                    "lowBasketSamples": counters.get("autonomous").get("Low Basket Samples"),
                    "highBasketSamples": counters.get("autonomous").get("High Basket Samples"),
                    "lowSpecimens": counters.get("autonomous").get("Low Specimens"),
                    "highSpecimens": counters.get("autonomous").get("High Specimens"),
                    "ascentScore": 0
                },
                "opMode": {
                    "netSamples": counters.get("opMode").get("Net Samples"),
                    "lowBasketSamples": counters.get("opMode").get("Low Basket Samples"),
                    "highBasketSamples": counters.get("opMode").get("High Basket Samples"),
                    "lowSpecimens": counters.get("opMode").get("Low Specimens"),
                    "highSpecimens": counters.get("opMode").get("High Specimens"),
                    "ascentScore": getSelectedRadioValueAsNumber()
                }
            })


            counters = new Map([
                ["autonomous", new Map()],
                ["opMode", new Map()]
            ])
            initializeModules()
            document.getElementById("teamNameInput").value = ""
        }

        function fetch_from_firebase(year_range) {
            const myRef = ref(database, "/");

            var resultArray = []


            const interperters = {
                "2024-2025": (snapshot) => {
                    resultArray = [["Team Name", "Date of Entry", "Autonomous Net Samples", "Autnomous Low Samples", "Autonomous High Samples", "Autonomous Low Specimens", "Autonmous High Specimens", "OpMode Net Samples", "OpMode Low Samples", "OpMode High Samples", "OpMode Low Specimens", "OpMode High Specimens", "OpMode Ascent"]];
                    if (snapshot.exists()) {
                        const allTeams = snapshot.val()
                        const allTeamsKeys = Object.keys(allTeams)
                        for (const teamIndex in allTeamsKeys) {
                            const team = allTeamsKeys[teamIndex]
                            const allTeamTimestamps = Object.keys(allTeams[team])
                            for (const timestampIndex in allTeamTimestamps) {
                                var timestamp = allTeamTimestamps[timestampIndex]
                                var autoValues = allTeams[team][timestamp]["autonomous"]
                                var opModeValues = allTeams[team][timestamp]["opMode"]
                                resultArray.push([team, timestamp, autoValues["netSamples"], autoValues["lowBasketSamples"], autoValues["highBasketSamples"], autoValues["lowSpecimens"], autoValues["highSpecimens"], opModeValues["netSamples"], opModeValues["lowBasketSamples"], opModeValues["highBasketSamples"], opModeValues["lowSpecimens"], opModeValues["highSpecimens"], opModeValues["ascentScore"]])
                            }
                        }
                    }
                    return resultArray
                },
            }


            return get(child(myRef, year_range)).then(interperters[year_range])
        }

        // Main function - takes 2D array and downloads as Excel
        function downloadExcelFromArray(data, filename = 'data.xlsx') {
            // Create workbook and worksheet
            const wb = XLSX.utils.book_new();
            const ws = XLSX.utils.aoa_to_sheet(data);

            // Add worksheet to workbook
            XLSX.utils.book_append_sheet(wb, ws, 'Sheet1');

            // Generate and download Excel file
            XLSX.writeFile(wb, filename);
        }

        async function SHA_256(input) {
            return await crypto.subtle.digest("SHA-256", base64ToInt8Array(input)).then(
                (hashBuffer) => {
                    const hashArray = Array.from(new Int8Array(hashBuffer))
                    return hashArray
                }
            )
        }


        async function validateFirebaseConfig() {
            if (arraysEqual(await SHA_256(inputtedPassword), passwordHash)) {
                if (app == null || database == null) {
                    firebaseConfig.apiKey = await decryptApiKey(inputtedPassword)
                    app = initializeApp(firebaseConfig)
                    database = getDatabase(app)
                }
                return true
            }
            else {
                alert("Bad Password!")
                location.href = "/index.html"
                return false
            }
        }

        function getPassword() {
            if ("password" in params) {
                return params["password"]
            }
            else {
                let inputtedPassword = prompt("Please enter the password: ")
                if (inputtedPassword != null && inputtedPassword != "") {
                    return inputtedPassword
                }
            }
        }

        const inputtedPassword = getPassword()

        if (await validateFirebaseConfig()) {
            populate_year_range_select()

            sendButton.addEventListener('click', async () => {
                if (await validateFirebaseConfig()) {
                    write_to_firebase()
                }
            })

            downloadButton.addEventListener('click', async () => {
                if (await validateFirebaseConfig()) {
                    var year_range = yearRangeSelect.value
                    fetch_from_firebase(year_range).then(data => {
                        downloadExcelFromArray(data, "scouting_data_" + year_range + ".xlsx")
                    })
                }
            })
        }

        initializeModules()
    </script>

    <script>
        let counters = new Map([
            ["autonomous", new Map()],
            ["opMode", new Map()]
        ])

        let autonomousCounterModules = ["Net Samples", "Low Basket Samples", "High Basket Samples", "Low Specimens", "High Specimens"]
        let opModeCounterModules = ["Net Samples", "Low Basket Samples", "High Basket Samples", "Low Specimens", "High Specimens"]


        function initializeModules() {
            const autonomousModulesContainer = document.getElementById("autonomousModulesContainer")
            const opModeModulesContainer = document.getElementById("opModeModulesContainer")

            for (var opModeStat in opModeCounterModules) {
                counters.get("opMode").set(opModeCounterModules[opModeStat], 0)
            }
            for (var autonomousStat in autonomousCounterModules) {
                counters.get("autonomous").set(autonomousCounterModules[autonomousStat], 0)
            }

            opModeModulesContainer.innerHTML = opModeCounterModules.map(title => `
                    <div class="module counter" id="counter-module-opMode-${sanitizeId(title)}">
                        <div class="module-title">${title}</div>
                        <div class="counter-display" id="counter-opMode-${sanitizeId(title)}">0</div>
                        <div class="counter-buttons">
                            <button class="counter-btn minus" onclick="updateCounter('opMode-${title}', -1)">−</button>
                            <button class="counter-btn plus" onclick="updateCounter('opMode-${title}', 1)">+</button>
                        </div>
                    </div>
                `).join("") + `
                    <div class="module radio" id="radio-module-opMode-ascent-level">
                        <div class="module-title">Ascent Level</div>
                        <input type="radio" name="opmode-ascent-level" value="0" id="no-ascent" checked>
                        <label for="no-ascent">No Ascent (0p)</label><br>

                        <input type="radio" name="opmode-ascent-level" value="3" id="parking">
                        <label for="parking">Parking (3p)</label><br>

                        <input type="radio" name="opmode-ascent-level" value="3" id="first-ascent">
                        <label for="first-ascent">First Ascent (3p)</label><br>

                        <input type="radio" name="opmode-ascent-level" value="15" id="second-ascent">
                        <label for="second-ascent">Second Ascent (15p)</label><br>

                        <input type="radio" name="opmode-ascent-level" value="30" id="third-ascent">
                        <label for="third-ascent">Third Ascent (30p)</label>
                    </div>
                `

            autonomousModulesContainer.innerHTML = autonomousCounterModules.map(title => `
                    <div class="module counter" id="counter-module-autonomous-${sanitizeId(title)}">
                        <div class="module-title">${title}</div>
                        <div class="counter-display" id="counter-autonomous-${sanitizeId(title)}">0</div>
                        <div class="counter-buttons">
                            <button class="counter-btn minus" onclick="updateCounter('autonomous-${title}', -1)">−</button>
                            <button class="counter-btn plus" onclick="updateCounter('autonomous-${title}', 1)">+</button>
                        </div>
                    </div>
                `).join("")

        }

        function sanitizeId(title) {
            return title.replace(/[^a-zA-Z0-9]/g, '-').toLowerCase();
        }

        function updateCounter(nameToUpdate, change) {
            const prefix = nameToUpdate.substring(0, nameToUpdate.indexOf("-"))
            const title = nameToUpdate.substring(nameToUpdate.indexOf("-") + 1)
            const currentValue = counters.get(prefix).get(title) || 0;
            const newValue = Math.max(0, currentValue + change); // Prevent negative values
            counters.get(prefix).set(title, newValue);

            const counterElement = document.getElementById(`counter-${prefix}-${sanitizeId(title)}`)
            counterElement.textContent = newValue
        }

        function getSelectedRadioValueAsNumber() {
            const selectedRadio = document.querySelector('input[name="opmode-ascent-level"]:checked');
            if (selectedRadio) {
                const valueAsString = selectedRadio.value;
                const valueAsNumber = parseInt(valueAsString, 10); // Or parseFloat() for decimals
                return valueAsNumber;
            }
            return null; // No radio button selected
        }
    </script>


    <select id="yearRangeSelect"></select><br>
    <button id="downloadScoutingDataButton">Download Data</button><br><br>
    <button id="sendButton">Send Scouting</button><br>
    <label for="teamNameInput">Enter team name:</label>
    <input type="text" id="teamNameInput" name="teamNameInput">
    <h1>Autonomous</h1><br>
    <div class="modules-container" id="autonomousModulesContainer"></div><br><br>
    <h1>OpMode</h1><br>
    <div class="modules-container" id="opModeModulesContainer"></div>
</body>

</html>